name: Build & Test

on:
  push:
    branches: [main, develop]
    tags:
      - "v*"

jobs:
  build-plugin:
    name: Build Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create distribution package
        run: |
          mkdir -p dist
          rsync -av --exclude-from='.distignore' . dist/my-plugin
          cd dist
          zip -r my-plugin-${{ github.ref_name }}.zip my-plugin

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: plugin-package
          path: dist/*.zip

  build-theme:
    name: Build Theme
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: wp-content/themes/my-theme
        run: npm ci

      - name: Build assets
        working-directory: wp-content/themes/my-theme
        run: npm run build

      - name: Create distribution package
        run: |
          mkdir -p dist
          cd wp-content/themes/my-theme
          zip -r ../../../dist/my-theme-${{ github.ref_name }}.zip . \
            -x "node_modules/*" \
            -x "src/*" \
            -x ".git/*" \
            -x "*.md"

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: theme-package
          path: dist/*.zip

  create-release:
    name: Create GitHub Release
    needs: [build-plugin, build-theme]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            plugin-package/*.zip
            theme-package/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
